<?xml version="1.0" encoding="UTF-8"?>
<project name="org.eclipse.help.webapp" default="plugin.zip" basedir=".">
  <target name="initTemplate" unless="template">
    <initTemplate/>
  </target>
  <target name="init" depends="initTemplate">
    <property name="plugin" value="org.eclipse.help.webapp"/>
    <property name="version" value="1.0.0"/>
    <property name="stamp" value=""/>
    <property name="os" value="win32"/>
    <property name="ws" value="win32"/>
    <property name="nl" value="en_US"/>
    <property name="arch" value="x86"/>
  </target>

  <target name="src.zip" depends="init">
    <property name="base" value="${basedir}/src.zip.pdetemp"/>
    <delete dir="${base}"/>
    <mkdir dir="${base}"/>
    <antcall target="src">
      <param name ="destroot" value="${base}/plugins/${plugin}_${version}"/>
    </antcall>
	<ant antfile="${template}" target="runZip">
      <property name="resultingFile" value="${basedir}/${plugin}_${version}.src.zip"/>
      <property name="targetDir" value="${base}"/>
	</ant>
    <delete dir="${base}"/>
  </target>

  <target name="plugin.zip" depends="bin.zip"/>
  <target name="bin.zip" depends="init">
    <property name="base" value="${basedir}/bin.zip.pdetemp"/>
    <delete dir="${base}"/>
    <mkdir dir="${base}"/>
    <antcall target="jar">
      <param name ="destroot" value="${base}/plugins/${plugin}_${version}"/>
    </antcall>
    <antcall target="bin">
      <param name ="destroot" value="${base}/plugins/${plugin}_${version}"/>
    </antcall>
    <delete>
      <fileset dir="${base}" includes="**/*.bin.log"/>
    </delete>
	<ant antfile="${template}" target="runZip">
      <property name="resultingFile" value="${basedir}/${plugin}_${version}.zip"/>
      <property name="targetDir" value="${base}"/>
	</ant>
    <delete dir="${base}"/>
  </target>

  <target name="log.zip" depends="init">
    <property name="base" value="${basedir}/log.zip.pdetemp"/>
    <delete dir="${base}"/>
    <mkdir dir="${base}"/>
    <antcall target="log">
      <param name ="destroot" value="${base}/plugins/${plugin}_${version}"/>
    </antcall>
	<ant antfile="${template}" target="runZip">
      <property name="resultingFile" value="${basedir}/${plugin}_${version}.log.zip"/>
      <property name="targetDir" value="${base}"/>
	</ant>
    <delete dir="${base}"/>
  </target>

  <target name="WEB-INF/lib/webapp.jar" depends="init">
    <ant antfile="${template}" target="jar">
      <property name="mapping" value="src/"/>
      <property name="includes" value="src/"/>
      <property name="excludes" value=""/>
      <property name="dest" value="${basedir}/WEB-INF/lib/webapp.jar"/>
      <property name="compilePath" value="../org.eclipse.core.runtime/bin;../org.eclipse.core.runtime/runtime.jar;../org.eclipse.core.boot/bin;../org.eclipse.core.boot/boot.jar;../org.apache.xerces/bin;../org.apache.xerces/xerces.jar;../org.eclipse.help/bin;../org.eclipse.help/help.jar;../org.eclipse.tomcat/servlet.jar"/>
    </ant>
    <delete file="${basedir}/WEB-INF/web.xml"/>
    <delete file="${basedir}/WEB-INF/lib/jsp.jar"/>
    <copy file="${basedir}/jsp.jar" todir="${basedir}/WEB-INF/lib"/>
    <copy file="${basedir}/web.xml" todir="${basedir}/WEB-INF"/>
  </target>

  <target name="jar" depends="init,WEB-INF/lib/webapp.jar">
  </target>

  <target name="WEB-INF/lib/webappsrc.zip" depends="init">
    <property name="destroot" value="${basedir}"/>
    <ant antfile="${template}" target="src">
      <property name="mapping" value="src/"/>
      <property name="includes" value="src/**/*.java"/>
      <property name="excludes" value=""/>
      <property name="dest" value="${destroot}/WEB-INF/lib/webappsrc.zip"/>
    </ant>
  </target>

  <target name="src" depends="init,WEB-INF/lib/webappsrc.zip">
  </target>

  <target name="bin" depends="init">
    <property name="destroot" value="${basedir}"/>
    <ant antfile="${template}" target="bin">
      <property name="includes" value="images/,infocenter/,ns4/,WEB-INF/,*.css,*.html,*.js,*.jsp,plugin.properties,plugin.xml,webapp.properties"/>
      <property name="excludes" value="src/"/>
      <property name="dest" value="${destroot}"/>
    </ant>
  </target>

  <target name="log" depends="init">
    <property name="destroot" value="${basedir}"/>
    <ant antfile="${template}" target="log">
      <property name="dest" value="${destroot}"/>
    </ant>
  </target>

  <target name="clean" depends="init">
    <ant antfile="${template}" target="clean">
      <property name="jar" value="WEB-INF/lib/webapp.jar"/>
      <property name="srczips" value="WEB-INF/lib/webappsrc.zip"/>
    </ant>
    <delete>
      <fileset dir="." includes="**/*.pdetemp"/>
    </delete>
    <delete file="${plugin}_${version}.zip"/>
    <delete file="${plugin}_${version}.src.zip"/>
    <delete file="${plugin}_${version}.doc.zip"/>
    <delete file="${plugin}_${version}.log.zip"/>
  </target>
  
  <!-- pass this in when running the script 
   <property name="tomcat.home" value="d:\programs\jakarta-tomcat-4.0.1"/>
  -->
	<path id="jasper.classpath" >  
		<pathelement location="${basedir}/WEB-INF/classes"/>
		<pathelement location="${basedir}/WEB-INF/lib/webapp.jar" />
		<pathelement location="${tomcat.home}/common/lib/xerces.jar"/>
		<pathelement location="${tomcat.home}/server/lib/catalina.jar" />
		<pathelement location="${tomcat.home}/common/lib/servlet.jar" />
		<pathelement location="${tomcat.home}/lib/jasper-compiler.jar" />
		<pathelement location="${tomcat.home}/lib/jasper-runtime.jar" />
		<pathelement location="${tomcat.home}/server/lib/tomcat_util.jar" />  
	</path>

	<target name="precompileJSP" depends="precompile.clean, precompile.default, precompile.ns4, precompile.jar">
	</target>
	
	<target name="precompile.clean">
	    <delete dir="${basedir}/temp" />
    </target>
    
	<target name="precompile.default">
		<property name="workdir" value="${basedir}/temp/default"/>
		<mkdir dir="${workdir}"/>
		<mkdir dir="${workdir}/classes"/>
		<copy todir="${workdir}/WEB-INF">
			<fileset dir="WEB-INF"/>
		</copy>
		<copy todir="${workdir}" >
			<fileset dir="${basedir}" includes="*.jsp" />
		</copy>
		<java
			taskname="jasper"
			classname="org.apache.jasper.JspC"
			fork="true"
			failonerror="true"
			classpathref="jasper.classpath">
			<arg value="-v3" />
			<arg value="-dd" /><arg value="${workdir}" />
			<arg value="-die" />
			<arg value="-p" /><arg value="jsp"/>
			<arg value="-webinc" /><arg value="${workdir}/temp_web.xml" />
			<arg value="-webapp" /><arg value="${workdir}" />
		</java>
		<javac
			srcdir="${workdir}"
			destdir="${workdir}/classes"
			debug="false"
			deprecation="false"
			optimize = "false"
			includes="**/*.java">
			<classpath refid="jasper.classpath" />
		</javac>
	</target>
	
	<target name="precompile.ns4">
		<property name="ns4workdir" value="${basedir}/temp/ns4"/>
		<mkdir dir="${ns4workdir}"/>
		<mkdir dir="${ns4workdir}/classes"/>
		<copy todir="${ns4workdir}/WEB-INF">
			<fileset dir="WEB-INF"/>
		</copy>
		<copy todir="${ns4workdir}" >
			<fileset dir="${basedir}/ns4" includes="*.jsp" />
		</copy>
		<java
			taskname="jasper"
			classname="org.apache.jasper.JspC"
			fork="true"
			failonerror="true"
			classpathref="jasper.classpath">
			<arg value="-v3" />
			<arg value="-dd" /><arg value="${ns4workdir}" />
			<arg value="-die" />
			<arg value="-p" /><arg value="jsp.ns4"/>
			<arg value="-uriroot" /><arg value="${basedir}/temp"/>
			<arg value="-webinc" /><arg value="${ns4workdir}/temp_web.xml" />
			<arg value="-webapp" /><arg value="${ns4workdir}" />
		</java>
		<javac
			srcdir="${ns4workdir}"
			destdir="${ns4workdir}/classes"
			debug="false"
			deprecation="false"
			optimize = "false"
			includes="**/*.java">
			<classpath refid="jasper.classpath" />
		</javac>
	</target>
	
	<target name="precompile.jar">
		<jar jarfile="${basedir}/jsp.jar"
			basedir="${basedir}/temp/default/classes"
			includes="**" />
		<jar jarfile="${basedir}/jsp.jar"
			basedir="${basedir}/temp/ns4/classes"
			includes="**" 
			update="yes"/>
	</target>
  
</project>
